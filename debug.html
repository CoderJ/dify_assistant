<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šè®®åŠ©æ‰‹è°ƒè¯•å·¥å…· - æµå¼å“åº”</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            display: flex;
            background-color: #f5f5f5;
        }

        .left-panel {
            width: 35%;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .right-panel {
            width: 65%;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .config-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .config-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .config-label {
            font-weight: 500;
            min-width: 60px;
            color: #555;
        }

        .config-select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .config-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .transcription-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            font-size: 14px;
            font-family: monospace;
            resize: none;
            outline: none;
            margin-bottom: 15px;
        }

        .transcription-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-input-area {
            border-top: 1px solid #e0e0e0;
            padding: 20px;
            background: white;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            border: 1px solid #007bff;
            border-radius: 20px;
            background: white;
            color: #007bff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: #007bff;
            color: white;
        }

        .quick-btn.active {
            background: #007bff;
            color: white;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            resize: none;
            outline: none;
            font-size: 14px;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .send-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .send-btn:hover {
            background: #0056b3;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background-color: #007bff;
            color: white;
        }

        .message.assistant {
            align-self: flex-start;
            background-color: #f1f3f4;
            color: #333;
        }

        .message.system {
            align-self: center;
            background-color: #fff3cd;
            color: #856404;
            font-size: 12px;
            max-width: 90%;
        }

        .questions-list {
            margin-top: 10px;
        }

        .question-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .question-item:hover {
            background-color: #f8f9fa;
        }

        .question-item .question {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .question-item .time {
            font-size: 12px;
            color: #666;
        }

        .loading {
            display: none;
            align-self: flex-start;
            background-color: #f1f3f4;
            color: #666;
            padding: 12px 16px;
            border-radius: 12px;
            font-style: italic;
        }

        .streaming-message {
            position: relative;
        }

        .streaming-message::after {
            content: '|';
            animation: blink 1s infinite;
            color: #007bff;
            font-weight: bold;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .format-note {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #0066cc;
        }

        .ai-button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .ai-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 40px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            min-width: 200px;
        }

        .ai-button:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .ai-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
        }

        .ai-button-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .ai-button-text {
            font-size: 18px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <h2 class="panel-title">ä¼šè®®åŠ©æ‰‹é…ç½®</h2>
        
        <div class="config-section">
            <div class="config-row">
                <label class="config-label">åœºæ™¯:</label>
                <select class="config-select" id="sceneSelect">
                    <option value="meeting">ä¼šè®® (meeting)</option>
                    <option value="interview">é¢è¯• (interview)</option>
                    <option value="talk">è®¿è°ˆ (talk)</option>
                </select>
            </div>
            <div class="config-row">
                <label class="config-label">è§’è‰²:</label>
                <select class="config-select" id="roleSelect">
                    <option value="participant">å‚ä¸è€… (participant)</option>
                    <option value="moderator">ä¸»æŒäºº (moderator)</option>
                    <option value="presenter">æ¼”è®²è€… (presenter)</option>
                    <option value="candidate">å€™é€‰äºº (candidate)</option>
                    <option value="interviewer">é¢è¯•å®˜ (interviewer)</option>
                    <option value="guest">å˜‰å®¾ (guest)</option>
                    <option value="host">ä¸»æŒäºº (host)</option>
                </select>
            </div>
        </div>

        <h2 class="panel-title">ä¼šè®®è½¬å½•è¾“å…¥</h2>
        
        <div class="format-note">
            <strong>è¯´æ˜ï¼š</strong>åœ¨æ­¤è¾“å…¥å®æ—¶çš„ä¼šè®®è½¬å½•å†…å®¹ï¼Œæ”¯æŒçº¯æ–‡æœ¬æ ¼å¼ã€‚
        </div>
        
        <textarea class="transcription-input" id="transcriptionInput" placeholder='è¯·è¾“å…¥è½¬å½•å†…å®¹ï¼Œä¾‹å¦‚ï¼š

ä¸»æŒäºº [00:10]: å¤§å®¶å¥½ï¼Œä»Šå¤©æˆ‘ä»¬è®¨è®ºä¸€ä¸‹æ–°äº§å“çš„ä¸Šå¸‚è®¡åˆ’ã€‚é¦–å…ˆè¯·äº§å“ç»ç†ä»‹ç»ä¸€ä¸‹äº§å“ç‰¹æ€§ã€‚

äº§å“ç»ç† [00:25]: è¿™ä¸ªäº§å“ä¸»è¦æœ‰ä¸‰ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼šæ™ºèƒ½æ¨èã€æ•°æ®åˆ†æå’Œç”¨æˆ·ç”»åƒã€‚é¢„è®¡ä¸‹ä¸ªæœˆå¯ä»¥å®Œæˆå¼€å‘ã€‚

å¸‚åœºæ€»ç›‘ [00:45]: å¬èµ·æ¥ä¸é”™ã€‚é‚£ä¹ˆæˆ‘ä»¬çš„ç›®æ ‡ç”¨æˆ·ç¾¤ä½“æ˜¯ä»€ä¹ˆï¼Ÿå®šä»·ç­–ç•¥æœ‰è€ƒè™‘è¿‡å—ï¼Ÿ

äº§å“ç»ç† [01:05]: ç›®æ ‡ç”¨æˆ·ä¸»è¦æ˜¯ä¸­å°ä¼ä¸šã€‚å®šä»·æ–¹é¢æˆ‘ä»¬è¿˜åœ¨è¯„ä¼°ï¼Œå¸Œæœ›èƒ½å¬å¬å¤§å®¶çš„æ„è§ã€‚

æˆ–è€…ç›´æ¥è¾“å…¥çº¯æ–‡æœ¬æ ¼å¼çš„è½¬å½•å†…å®¹...'></textarea>

        <div class="controls">
            <button class="btn btn-secondary" onclick="clearTranscription()">æ¸…ç©º</button>
            <button class="btn btn-secondary" id="loadSampleBtn" onclick="loadSample()">åŠ è½½ç¤ºä¾‹</button>
            <button class="btn btn-secondary" id="pauseLoadingBtn" onclick="pauseLoading()" style="display: none;">â¸ï¸ æš‚åœ</button>
            <button class="btn btn-secondary" id="resumeLoadingBtn" onclick="resumeLoading()" style="display: none;">â–¶ï¸ ç»§ç»­</button>
            <button class="btn btn-secondary" id="fastForwardBtn" onclick="fastForward15s()" style="display: none;">â© å¿«è¿›15ç§’</button>
        </div>
        
        <div id="loadingProgress" style="display: none; margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 6px; font-size: 12px;">
            <div id="loadingStatus">æ­£åœ¨æ¨¡æ‹Ÿä¼šè®®è½¬å½•ä¸­...</div>
            <div id="progressText">å·²åŠ è½½: 0 / 0</div>
            <div style="margin-top: 5px; background: #e0e0e0; border-radius: 3px; height: 4px;">
                <div id="progressBar" style="background: #007bff; height: 100%; border-radius: 3px; width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="chat-container">
            <div class="chat-header">
                <h2 class="panel-title">AI åŠ©æ‰‹å¯¹è¯</h2>
                <button class="btn btn-secondary" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    æ¬¢è¿ä½¿ç”¨ä¼šè®®åŠ©æ‰‹ï¼ä½¿ç”¨æµå¼å“åº”ï¼ŒAIå›ç­”ä¼šå®æ—¶æ˜¾ç¤ºã€‚è¯·é…ç½®åœºæ™¯å’Œè§’è‰²ï¼Œè¾“å…¥è½¬å½•å†…å®¹ï¼Œç„¶åä½¿ç”¨ä¸‹æ–¹çš„AIåŠ©æ‰‹æŒ‰é’®å¼€å§‹å¯¹è¯ã€‚
                </div>
            </div>

            <div class="loading" id="loadingIndicator">
                AIæ­£åœ¨å¤„ç†ä¸­...
            </div>

            <div class="chat-input-area">
                <div class="ai-button-container">
                    <button class="ai-button" onclick="sendAIRequest()">
                        <div class="ai-button-icon">ğŸ¤–</div>
                        <div class="ai-button-text">AI åŠ©æ‰‹</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentConversationId = "";
        let lastRequestType = "";
        let lastAnswer = "";
        let lastQuestion = "";
        let loadingTimer = null;
        let currentLoadingIndex = 0;
        let isPaused = false;
        let loadingSpeed = 1000; // é»˜è®¤1ç§’é—´éš”
        let meetingData = []; // å°†ä»test.jsonåŠ¨æ€åŠ è½½
        
        function clearTranscription() {
            // åœæ­¢æ­£åœ¨è¿›è¡Œçš„åŠ è½½
            if (loadingTimer) {
                clearTimeout(loadingTimer);
                loadingTimer = null;
            }
            document.getElementById('transcriptionInput').value = '';
            currentLoadingIndex = 0;
            isPaused = false;
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            document.getElementById('loadSampleBtn').style.display = 'inline-block';
            document.getElementById('pauseLoadingBtn').style.display = 'none';
            document.getElementById('resumeLoadingBtn').style.display = 'none';
            document.getElementById('fastForwardBtn').style.display = 'none';
            document.getElementById('loadingProgress').style.display = 'none';
        }

        function loadSample() {
            // åœæ­¢ä¹‹å‰çš„åŠ è½½ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if (loadingTimer) {
                clearTimeout(loadingTimer);
                loadingTimer = null;
            }
            
            // æ¸…ç©ºå½“å‰å†…å®¹
            document.getElementById('transcriptionInput').value = '';
            currentLoadingIndex = 0;
            isPaused = false;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loadSampleBtn').style.display = 'none';
            document.getElementById('pauseLoadingBtn').style.display = 'none';
            document.getElementById('resumeLoadingBtn').style.display = 'none';
            document.getElementById('fastForwardBtn').style.display = 'none';
            document.getElementById('loadingProgress').style.display = 'block';
            document.getElementById('loadingStatus').textContent = 'æ­£åœ¨åŠ è½½ä¼šè®®æ•°æ®...';
            
            // å…ˆåŠ è½½test.jsonæ•°æ®
            fetch('test.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('æ— æ³•åŠ è½½test.jsonæ–‡ä»¶');
                    }
                    return response.json();
                })
                .then(data => {
                    meetingData = data;
                    console.log(`æˆåŠŸåŠ è½½ ${meetingData.length} æ¡ä¼šè®®è®°å½•`);
                    
                    // å¼€å§‹æ¨¡æ‹ŸåŠ è½½
                    document.getElementById('loadingStatus').textContent = 'æ­£åœ¨æ¨¡æ‹Ÿä¼šè®®è½¬å½•ä¸­...';
                    document.getElementById('pauseLoadingBtn').style.display = 'inline-block';
                    document.getElementById('fastForwardBtn').style.display = 'inline-block';
                    loadNextItem();
                })
                .catch(error => {
                    console.error('åŠ è½½test.jsonå¤±è´¥:', error);
                    document.getElementById('loadingStatus').textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
                    document.getElementById('loadSampleBtn').style.display = 'inline-block';
                    document.getElementById('loadingProgress').style.display = 'none';
                });
        }
        
        function loadNextItem() {
            if (isPaused) return;
            
            if (currentLoadingIndex >= meetingData.length) {
                // åŠ è½½å®Œæˆ
                document.getElementById('loadingStatus').textContent = 'ä¼šè®®è½¬å½•å®Œæˆï¼';
                document.getElementById('loadSampleBtn').style.display = 'inline-block';
                document.getElementById('pauseLoadingBtn').style.display = 'none';
                document.getElementById('resumeLoadingBtn').style.display = 'none';
                document.getElementById('fastForwardBtn').style.display = 'none';
                document.getElementById('loadingProgress').style.display = 'none';
                return;
            }
            
            const item = meetingData[currentLoadingIndex];
            const currentText = document.getElementById('transcriptionInput').value;
            const newContent = `${item.speaker} [${item.startTime}]: ${item.content}\n\n`;
            document.getElementById('transcriptionInput').value = currentText + newContent;
            
            currentLoadingIndex++;
            updateProgress();
            
            // è®¡ç®—ä¸‹ä¸€ä¸ªé¡¹ç›®çš„å»¶è¿Ÿæ—¶é—´
            let nextDelay = 1000; // é»˜è®¤1ç§’
            if (currentLoadingIndex < meetingData.length) {
                const currentTime = parseTimeToSeconds(item.startTime);
                const nextTime = parseTimeToSeconds(meetingData[currentLoadingIndex].startTime);
                const timeDiff = nextTime - currentTime;
                // æ ¹æ®æ—¶é—´å·®è°ƒæ•´åŠ è½½é€Ÿåº¦ï¼Œä½†ä¸è¶…è¿‡3ç§’
                nextDelay = Math.min(timeDiff * 1000, 3000);
            }
            
            loadingTimer = setTimeout(loadNextItem, nextDelay);
        }
        
        function parseTimeToSeconds(timeStr) {
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
        }
        
        function updateProgress() {
            const progress = (currentLoadingIndex / meetingData.length) * 100;
            document.getElementById('progressText').textContent = `å·²åŠ è½½: ${currentLoadingIndex} / ${meetingData.length}`;
            document.getElementById('progressBar').style.width = progress + '%';
        }
        
        function pauseLoading() {
            isPaused = true;
            if (loadingTimer) {
                clearTimeout(loadingTimer);
                loadingTimer = null;
            }
            document.getElementById('pauseLoadingBtn').style.display = 'none';
            document.getElementById('resumeLoadingBtn').style.display = 'inline-block';
            document.getElementById('loadingStatus').textContent = 'å·²æš‚åœ';
        }
        
        function resumeLoading() {
            isPaused = false;
            document.getElementById('pauseLoadingBtn').style.display = 'inline-block';
            document.getElementById('resumeLoadingBtn').style.display = 'none';
            document.getElementById('loadingStatus').textContent = 'æ­£åœ¨æ¨¡æ‹Ÿä¼šè®®è½¬å½•ä¸­...';
            loadNextItem();
        }

        function addMessage(type, content, isJson = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (isJson && type === 'assistant') {
                // å¤„ç†JSONå“åº”
                try {
                    const jsonData = JSON.parse(content);
                    
                    if (jsonData.type === 'questions' && jsonData.questions) {
                        // å¤„ç†å‘ç°é—®é¢˜å“åº”
                        const textContent = document.createElement('div');
                        textContent.textContent = 'å‘ç°ä»¥ä¸‹é—®é¢˜ï¼Œ ç‚¹å‡»ä»¥è®©AIè¿›è¡Œä½œç­”ï¼š';
                        messageDiv.appendChild(textContent);
                        
                        const questionsList = document.createElement('div');
                        questionsList.className = 'questions-list';
                        
                        jsonData.questions.forEach((q, index) => {
                            const questionItem = document.createElement('div');
                            questionItem.className = 'question-item';
                            questionItem.onclick = () => selectQuestion(q.question);
                            
                            const questionText = document.createElement('div');
                            questionText.className = 'question';
                            questionText.textContent = `${index + 1}. ${q.question}`;
                            questionItem.appendChild(questionText);
                            
                            if (q.time) {
                                const timeText = document.createElement('div');
                                timeText.className = 'time';
                                timeText.textContent = `æ—¶é—´: ${q.time}`;
                                questionItem.appendChild(timeText);
                            }
                            
                            questionsList.appendChild(questionItem);
                        });
                        
                        messageDiv.appendChild(questionsList);
                    } else {
                        // å¦‚æœä¸æ˜¯å·²çŸ¥æ ¼å¼ï¼Œç›´æ¥æ˜¾ç¤ºæ–‡æœ¬å†…å®¹
                        messageDiv.textContent = content;
                    }
                } catch (e) {
                    messageDiv.textContent = content;
                }
            } else {
                messageDiv.textContent = content;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function selectQuestion(question) {
            console.log('é€‰æ‹©é—®é¢˜:', question);
            lastQuestion = question; // è®°ä½è¢«é€‰æ‹©çš„é—®é¢˜
            addMessage('system', `å·²é€‰æ‹©é—®é¢˜: ${question}`);
            
            // è‡ªåŠ¨å‘é€å›ç­”é—®é¢˜è¯·æ±‚
            setTimeout(() => {
                sendRequest('answer_question', question);
            }, 500);
        }

        function sendAIRequest() {
            const transcription = document.getElementById('transcriptionInput').value.trim();
            
            if (!transcription) {
                addMessage('system', 'è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥è½¬å½•å†…å®¹');
                return;
            }

            addMessage('user', 'ğŸ¤– è¯·æ±‚AIåŠ©æ‰‹å¸®åŠ©');
            
            // å‘é€AIè¯·æ±‚
            sendRequest('ai_help', '');
        }

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        async function sendRequest(requestType, requestContent) {
            const transcription = document.getElementById('transcriptionInput').value.trim();
            const scene = document.getElementById('sceneSelect').value;
            const role = document.getElementById('roleSelect').value;
            
            if (!transcription) {
                addMessage('system', 'è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥è½¬å½•å†…å®¹');
                return;
            }

            const requestData = {
                transcription: transcription,
                scene: scene,
                role: role,
                request_type: requestType,
                request_content: requestContent,
                conversation_id: currentConversationId
            };

            lastRequestType = requestType;

            showLoading();

            try {
                let response;
                
                // ä½¿ç”¨æµå¼API
                response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                hideLoading();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // å¤„ç†æµå¼å“åº”
                await handleStreamingResponse(response);

            } catch (error) {
                hideLoading();
                addMessage('system', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        async function handleStreamingResponse(response) {
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨ç”¨äºæµå¼æ˜¾ç¤º
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant streaming-message';
            messageDiv.id = 'streaming-message';
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            let fullAnswer = '';
            let conversationId = '';
            let messageId = '';

            // åˆ›å»ºEventSourceæ¥è¯»å–æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                
                if (done) {
                    break;
                }

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6); // ç§»é™¤ 'data: ' å‰ç¼€
                        
                        if (data === '[DONE]') {
                            break;
                        }

                        try {
                            const parsed = JSON.parse(data);
                            
                            if (parsed.type === 'content') {
                                // æ·»åŠ æ–°çš„å†…å®¹åˆ°æ¶ˆæ¯ä¸­
                                fullAnswer += parsed.content;
                                messageDiv.textContent = fullAnswer;
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                
                                // ä¿å­˜conversation_idå’Œmessage_id
                                if (parsed.conversation_id) conversationId = parsed.conversation_id;
                                if (parsed.message_id) messageId = parsed.message_id;
                            } else if (parsed.type === 'error') {
                                // æ˜¾ç¤ºé”™è¯¯
                                messageDiv.textContent = `é”™è¯¯: ${parsed.error}`;
                                messageDiv.className = 'message system';
                                break;
                            } else if (parsed.type === 'done') {
                                // æµç»“æŸ
                                if (parsed.conversation_id) conversationId = parsed.conversation_id;
                                if (parsed.message_id) messageId = parsed.message_id;
                                break;
                            }
                        } catch (e) {
                            console.log('è§£ææµæ•°æ®æ—¶å‡ºé”™:', e);
                        }
                    }
                }
            }

            // ä¿å­˜conversation_id
            if (conversationId) {
                currentConversationId = conversationId;
            }

            // ä¿å­˜æœ€åçš„ç­”æ¡ˆ
            lastAnswer = fullAnswer;

            // å°è¯•è§£æJudge Functionçš„JSONå“åº”
            try {
                const jsonAnswer = JSON.parse(fullAnswer);
                if (jsonAnswer.function) {
                    // è¿™æ˜¯Judge Functionçš„å“åº”ï¼Œæå–functionå€¼
                    messageDiv.textContent = jsonAnswer.function;
                    lastAnswer = jsonAnswer.function;
                    console.log('Judge Functionè¿”å›çš„function:', jsonAnswer.function);
                }
            } catch (e) {
                // ä¸æ˜¯JSONæ ¼å¼ï¼Œä¿æŒåŸæ ·
                console.log('å“åº”ä¸æ˜¯JSONæ ¼å¼ï¼Œä¿æŒåŸæ ·');
            }

            // ç§»é™¤ä¸´æ—¶IDå’Œæµå¼æ ·å¼
            messageDiv.removeAttribute('id');
            messageDiv.classList.remove('streaming-message');
        }

        function clearChat() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="message system">
                    å¯¹è¯å·²æ¸…ç©ºã€‚è¯·ç»§ç»­ä¸AIåŠ©æ‰‹å¯¹è¯ã€‚
                </div>
            `;
            currentConversationId = "";
            lastRequestType = "";
            lastAnswer = "";
            lastQuestion = "";
        }

        // ç»‘å®šå›è½¦å‘é€
        document.getElementById('transcriptionInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAIRequest();
            }
        });

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        document.getElementById('transcriptionInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥test.jsonæ–‡ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥test.jsonæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            fetch('test.json')
                .then(response => {
                    if (response.ok) {
                        console.log('test.jsonæ–‡ä»¶å­˜åœ¨ï¼Œå¯ä»¥å¼€å§‹åŠ è½½ç¤ºä¾‹');
                        document.getElementById('loadSampleBtn').disabled = false;
                    } else {
                        throw new Error('test.jsonæ–‡ä»¶ä¸å­˜åœ¨');
                    }
                })
                .catch(error => {
                    console.warn('test.jsonæ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®:', error);
                    document.getElementById('loadSampleBtn').disabled = true;
                    document.getElementById('loadSampleBtn').title = 'test.jsonæ–‡ä»¶ä¸å­˜åœ¨';
                });
        });

        function fastForward15s() {
            if (isPaused) return;
            
            // è®¡ç®—å½“å‰æ—¶é—´ç‚¹
            let currentTime = 0;
            if (currentLoadingIndex > 0 && currentLoadingIndex < meetingData.length) {
                currentTime = parseTimeToSeconds(meetingData[currentLoadingIndex - 1].startTime);
            }
            
            // ç›®æ ‡æ—¶é—´ï¼šå½“å‰æ—¶é—´ + 15ç§’
            const targetTime = currentTime + 15;
            
            // æ‰¾åˆ°ç›®æ ‡æ—¶é—´åçš„ç¬¬ä¸€ä¸ªé¡¹ç›®
            let targetIndex = currentLoadingIndex;
            while (targetIndex < meetingData.length) {
                const itemTime = parseTimeToSeconds(meetingData[targetIndex].startTime);
                if (itemTime >= targetTime) {
                    break;
                }
                targetIndex++;
            }
            
            // å¦‚æœæ‰¾åˆ°äº†ç›®æ ‡é¡¹ç›®ï¼Œå¿«é€ŸåŠ è½½åˆ°è¯¥ä½ç½®
            if (targetIndex < meetingData.length) {
                // æ¸…é™¤å½“å‰å®šæ—¶å™¨
                if (loadingTimer) {
                    clearTimeout(loadingTimer);
                    loadingTimer = null;
                }
                
                // å¿«é€ŸåŠ è½½åˆ°ç›®æ ‡ä½ç½®
                while (currentLoadingIndex < targetIndex) {
                    const item = meetingData[currentLoadingIndex];
                    const currentText = document.getElementById('transcriptionInput').value;
                    const newContent = `${item.speaker} [${item.startTime}]: ${item.content}\n\n`;
                    document.getElementById('transcriptionInput').value = currentText + newContent;
                    currentLoadingIndex++;
                }
                
                updateProgress();
                
                // ç»§ç»­æ­£å¸¸åŠ è½½
                loadNextItem();
            }
        }
    </script>
</body>
</html> 